<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smiti Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Hind+Siliguri:wght@400;500;600;700&display=swap');
        :root { --primary: #00695c; --bg: #f8fafc; --white: #ffffff; --text: #1e293b; --card-bg: #ffffff; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', 'Hind Siliguri', sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        
        /* --- Login Page Styles (New) --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, var(--primary), #004d40);
            z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 20px;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 380px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center;
        }
        .login-box img { width: 80px; height: 80px; margin-bottom: 15px; border-radius: 50%; border: 3px solid #eee; object-fit: cover; }
        .login-box h2 { color: var(--primary); margin-bottom: 20px; font-size: 22px; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: #f9f9f9; }
        .login-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; transition: 0.3s; }
        .login-btn:active { transform: scale(0.98); }
        .login-error { color: #dc2626; font-size: 13px; margin-top: 10px; display: none; background: #fee2e2; padding: 8px; border-radius: 5px; }

        /* Hide content by default until login */
        .mobile-container { display: none; width: 100%; max-width: 480px; background: var(--white); height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); flex-direction: column; }
        
        /* --- Your Original Styles --- */
        .header { background: linear-gradient(135deg, var(--primary), #004d40); padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; color: white; border-radius: 0 0 20px 20px; flex-shrink: 0; }
        .header-logo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid white; }
        .content-body { flex-grow: 1; overflow-y: auto; padding-bottom: 20px; }
        .stats-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 20px; }
        .stat-card { background: var(--card-bg); padding: 15px 10px; border-radius: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: var(--text); border: 1px solid #eee; }
        .stat-card.full-width { grid-column: span 2; background: #e0f2f1; border-color: #b2dfdb; }
        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 0 20px; }
        .menu-item { background: var(--card-bg); padding: 15px 5px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; color: var(--text); height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #f1f5f9; transition: 0.2s; }
        .menu-item:active { transform: scale(0.97); }
        .menu-icon { font-size: 22px; color: var(--primary); margin-bottom: 8px; background: #e0f2f1; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .section-title { padding: 0 20px; margin: 20px 0 10px; font-weight: 600; color: #64748b; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-content { background: var(--card-bg); width: 95%; max-width: 400px; padding: 20px; border-radius: 15px; max-height: 90vh; overflow-y: auto; color: var(--text); position: relative; display: flex; flex-direction: column; }
        .modal-close-icon { position: absolute; top: 15px; right: 20px; font-size: 24px; color: #64748b; cursor: pointer; transition: 0.2s; z-index: 10; }
        .modal-close-icon:hover { color: #dc2626; }
        .modern-btn { width: 100%; padding: 12px; border-radius: 8px; background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 14px; }
        .smart-card { background: var(--card-bg); padding: 12px; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--primary); color: var(--text); font-size: 14px; position: relative; }
        .footer { text-align: center; padding: 10px; font-size: 11px; color: #aaa; border-top: 1px solid #eee; background: var(--card-bg); }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; font-size: 14px; }
        .approve-btn { background: #059669; color: white; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; margin-right: 5px; }
        .reject-btn { background: #dc2626; color: white; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; }
        .search-container { position: sticky; top: 0; background: white; z-index: 5; padding-bottom: 10px; }
        .search-input { width: 100%; padding: 10px 35px 10px 15px; border-radius: 20px; border: 1px solid #ddd; background: #f1f5f9; }
        .search-icon { position: absolute; right: 15px; top: 22px; color: #64748b; }
        .chat-wrapper { display: flex; flex-direction: column; height: 100%; background: #e5ddd5; position: relative; border-radius: 10px; overflow: hidden; }
        .chat-body { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; padding-bottom: 70px; scroll-behavior: smooth; }
        .chat-footer { position: absolute; bottom: 0; left: 0; width: 100%; padding: 10px; background: #fff; display: flex; gap: 10px; align-items: center; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
        .chat-bubble { max-width: 75%; padding: 8px 12px; border-radius: 8px; font-size: 14px; line-height: 1.4; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .bubble-admin { align-self: flex-end; background: #dcf8c6; color: #000; border-top-right-radius: 0; }
        .bubble-user { align-self: flex-start; background: #fff; color: #000; border-top-left-radius: 0; }
        .chat-meta { display: flex; justify-content: flex-end; align-items: center; gap: 6px; margin-top: 4px; }
        .chat-time { font-size: 10px; color: #777; }
        .chat-tick { font-size: 10px; color: #999; }
        .chat-tick.seen { color: #34b7f1; }
        .delete-msg-btn { font-size: 10px; color: #ef4444; cursor: pointer; padding: 2px 5px; background: rgba(255,255,255,0.5); border-radius: 4px; }
        .chat-img-preview { max-width: 100%; border-radius: 5px; margin-bottom: 5px; border: 1px solid #ccc; cursor: pointer; display: block; }
        .chat-input { width: 100%; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd; outline: none; background: #f9f9f9; max-height: 100px; resize: none; font-family: inherit; }
        .chat-btn-send { background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; transition: 0.2s; }
        .chat-btn-send:active { transform: scale(0.9); }
        .chat-btn-attach { color: #666; font-size: 20px; cursor: pointer; padding: 5px; }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-box">
            <img src="https://i.ibb.co/5GzXk6n/logo.png" alt="Logo" id="login-logo-img">
            <h2 id="login-org-name">Admin Login</h2>
            <input type="email" id="login-email" placeholder="ইমেইল অ্যাড্রেস">
            <input type="password" id="login-pass" placeholder="পাসওয়ার্ড">
            <button class="login-btn" id="btn-login-submit">লগইন করুন</button>
            <div id="login-error-msg" class="login-error">ইমেইল বা পাসওয়ার্ড ভুল!</div>
        </div>
    </div>

    <!-- Main Content Container (Original) -->
    <div class="mobile-container" id="main-admin-panel">
        <div class="header">
            <div style="display:flex; align-items:center; gap:10px;">
                <img class="header-logo" id="admin-logo-view" src="https://i.ibb.co/5GzXk6n/logo.png">
                <div><div style="font-size:16px; font-weight:bold" id="admin-title-view">Admin Panel</div><div style="font-size:11px; opacity:0.8">Administrator</div></div>
            </div>
            <i class="fa-solid fa-power-off" id="logout-btn" style="cursor:pointer; background:rgba(255,255,255,0.2); padding:8px; border-radius:50%"></i>
        </div>

        <div class="content-body">
            <div class="stats-container">
                <div class="stat-card full-width"><span style="font-size:20px; font-weight:bold; display:block; color:var(--primary)">৳ <span id="adm-total">0</span></span><span style="font-size:12px; font-weight:500;">মোট ফান্ড (জরিমানা ছাড়া)</span></div>
                <div class="stat-card"><span style="font-size:16px; font-weight:bold; display:block; color:#dc2626">৳ <span id="adm-due">0</span></span><span style="font-size:11px">মোট বকেয়া</span></div>
                <div class="stat-card"><span style="font-size:16px; font-weight:bold; display:block"><span id="adm-mem">0</span></span><span style="font-size:11px">মোট সদস্য</span></div>
                <div class="stat-card"><span style="font-size:16px; font-weight:bold; display:block; color:#ca8a04">৳ <span id="adm-fine-due">0</span></span><span style="font-size:11px">মোট জরিমানা বাকি</span></div>
                <div class="stat-card"><span style="font-size:16px; font-weight:bold; display:block; color:#059669">৳ <span id="adm-fine-coll">0</span></span><span style="font-size:11px">মোট জরিমানা আদায়</span></div>
            </div>

            <div class="section-title">কন্ট্রোল প্যানেল</div>
            <div class="menu-grid">
                <div class="menu-item" id="btn-approv"><i class="menu-icon fa-solid fa-user-check"></i><span>সদস্য রিকুয়েস্ট</span></div>
                <div class="menu-item" id="btn-deposit-req"><i class="menu-icon fa-solid fa-check-double"></i><span>জমা রিকুয়েস্ট</span></div>
                <div class="menu-item" id="btn-money-entry"><i class="menu-icon fa-solid fa-plus-circle"></i><span>টাকা এন্ট্রি</span></div>
                <div class="menu-item" id="btn-extra-collection"><i class="menu-icon fa-solid fa-hand-holding-heart"></i><span>অতিরিক্ত আদায়</span></div>
                <div class="menu-item" id="btn-fine-collection"><i class="menu-icon fa-solid fa-money-bill-wave" style="color:#ca8a04; background:#fef9c3"></i><span>জরিমানা আদায়</span></div>
            </div>

            <div class="section-title">ম্যানেজমেন্ট</div>
            <div class="menu-grid">
                <div class="menu-item" id="btn-member-list"><i class="menu-icon fa-solid fa-users"></i><span>সদস্য তালিকা</span></div>
                <div class="menu-item" id="btn-due-list"><i class="menu-icon fa-solid fa-file-invoice"></i><span>বাকি তালিকা</span></div>
                <div class="menu-item" id="btn-deposit-list"><i class="menu-icon fa-solid fa-list-check"></i><span>জমা তালিকা</span></div>
                <div class="menu-item" id="btn-extra-fee-setup"><i class="menu-icon fa-solid fa-gift"></i><span>অতিরিক্ত ফি</span></div>
                <div class="menu-item" id="btn-complaint-inbox"><div class="menu-icon" style="background:#fef2f2; color:#ef4444"><i class="fa-brands fa-whatsapp"></i></div><span>অভিযোগ বক্স</span></div>
                <div class="menu-item" id="btn-decisions"><div class="menu-icon" style="background:#e0e7ff; color:#4f46e5"><i class="fa-solid fa-gavel"></i></div><span>সিদ্ধান্ত</span></div>
                <div class="menu-item" id="btn-meeting-admin"><div class="menu-icon" style="background:#f3e8ff; color:#9333ea"><i class="fa-solid fa-handshake"></i></div><span>মিটিং সেটআপ</span></div>
                <div class="menu-item" id="btn-fine-management"><div class="menu-icon" style="background:#fef9c3; color:#ca8a04"><i class="fa-solid fa-triangle-exclamation"></i></div><span>জরিমানা সেট</span></div>
                <div class="menu-item" id="btn-monthly-fee"><i class="menu-icon fa-solid fa-calendar-check"></i><span>মাসিক ফি</span></div>
                <div class="menu-item" id="btn-app-config"><i class="menu-icon fa-solid fa-gear"></i><span>সেটিংস</span></div>
                <div class="menu-item" id="btn-balance-fix"><i class="menu-icon fa-solid fa-wrench"></i><span>ডাটা ফিক্স</span></div>
                <div class="menu-item" id="btn-rules"><i class="menu-icon fa-solid fa-book-open"></i><span>নিয়মাবলী</span></div>
                <div class="menu-item" id="btn-notice"><i class="menu-icon fa-solid fa-bullhorn"></i><span>নোটিশ বোর্ড</span></div>
            </div>
        </div>
        <div class="footer">© 2024 Admin Control Panel</div>
    </div>

    <!-- All Original Modals (No changes here) -->
    <div id="approv-modal" class="modal"><div class="modal-content"><i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('approv-modal').style.display='none'"></i><h3>সদস্য রিকুয়েস্ট</h3><div id="req-list-container"></div></div></div>
    <div id="deposit-approv-modal" class="modal"><div class="modal-content"><i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('deposit-approv-modal').style.display='none'"></i><h3>জমা রিকুয়েস্ট</h3><div id="deposit-req-list"></div></div></div>
    
    <div id="member-list-modal" class="modal">
        <div class="modal-content">
            <i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('member-list-modal').style.display='none'"></i>
            <h3>সদস্য তালিকা (<span id="total-mem-count">0</span>)</h3>
            <div class="search-container">
                <input type="text" id="member-search-input" class="search-input" placeholder="নাম বা নাম্বার দিয়ে খুঁজুন...">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
            </div>
            <div id="member-list-container"></div>
        </div>
    </div>
    
    <div id="complaint-inbox-modal" class="modal"><div class="modal-content"><i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('complaint-inbox-modal').style.display='none'"></i><h3 style="color:#ef4444"><i class="fa-brands fa-whatsapp"></i> ইনবক্স</h3><div id="complaint-inbox-list"></div></div></div>
    
    <div id="entry-modal" class="modal">
        <div class="modal-content">
            <i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('entry-modal').style.display='none'"></i>
            <h3>টাকা জমা (মাসিক)</h3>
            <select id="entry-name"></select>
            <div style="display:flex;gap:5px">
                <select id="entry-year"></select>
                <select id="entry-month">
                    <option>January</option><option>February</option><option>March</option><option>April</option>
                    <option>May</option><option>June</option><option>July</option><option>August</option>
                    <option>September</option><option>October</option><option>November</option><option>December</option>
                </select>
            </div>
            <label style="font-size:12px; margin-top:5px; display:block">জমার তারিখ:</label>
            <input type="date" id="entry-date">
            <label style="font-size:12px; font-weight:bold; color:var(--primary)">নির্ধারিত মাসিক ফি:</label>
            <input type="number" id="entry-amount" placeholder="টাকা (অটো)" readonly style="background:#e2e8f0; cursor:not-allowed;">
            <select id="entry-method"><option>Cash</option><option>Bkash</option><option>Nagad</option></select>
            <textarea id="entry-note" rows="2" placeholder="মন্তব্য"></textarea>
            <button class="modern-btn" id="btn-submit-entry">জমা দিন</button>
        </div>
    </div>

    <div id="fine-collection-modal" class="modal">
        <div class="modal-content">
            <i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('fine-collection-modal').style.display='none'"></i>
            <h3 style="color:#ca8a04">জরিমানা আদায়</h3>
            <select id="fine-coll-name"><option>সদস্য সিলেক্ট করুন</option></select>
            <input type="number" id="fine-coll-amount" placeholder="জরিমানার পরিমাণ (টাকা)">
            <label style="font-size:12px; margin-top:5px; display:block">জমার তারিখ:</label>
            <input type="date" id="fine-coll-date">
            <select id="fine-coll-month"><option>January</option><option>February</option><option>March</option><option>April</option><option>May</option><option>June</option><option>July</option><option>August</option><option>September</option><option>October</option><option>November</option><option>December</option></select>
            <select id="fine-coll-year"></select>
            <select id="fine-coll-method"><option>Cash</option><option>Bkash</option><option>Nagad</option></select>
            <textarea id="fine-coll-note" rows="2" placeholder="মন্তব্য (Optional)"></textarea>
            <button class="modern-btn" id="btn-submit-fine-coll" style="background:#ca8a04">জরিমানা জমা দিন</button>
        </div>
    </div>

    <div id="fine-modal" class="modal"><div class="modal-content"><i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('fine-modal').style.display='none'"></i><h3>জরিমানা সেটিংস</h3><div style="background:#fef9c3; padding:15px; border-radius:10px; margin-bottom:20px;"><label style="font-size:13px; font-weight:bold;">মাসের শেষ তারিখ:</label><select id="fine-late-date"></select><label style="font-size:13px; font-weight:bold; margin-top:10px; display:block">জরিমানার পরিমাণ (টাকা):</label><input type="number" id="fine-amount" placeholder="যেমন: ১০"><button class="modern-btn" id="btn-save-fine-config" style="background:#ca8a04">সেটিংস সেভ করুন</button></div><h3>সকল সদস্যের জরিমানা</h3><div id="all-users-fine-list"></div></div></div>
    <div id="meeting-modal" class="modal"><div class="modal-content"><i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('meeting-modal').style.display='none'"></i><h3>নতুন মিটিং শিডিউল</h3><label>তারিখ:</label><input type="date" id="meeting-date"><label>সময়:</label><input type="time" id="meeting-time"><label>উদ্দেশ্য:</label><textarea id="meeting-purpose" rows="2" placeholder="মিটিংয়ের বিষয়বস্তু..."></textarea><button class="modern-btn" id="btn-save-meeting">পোস্ট করুন</button><h4 style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">পূর্ববর্তী মিটিং</h4><div id="admin-meeting-list"></div></div></div>
    <div id="fee-modal" class="modal"><div class="modal-content"><i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('fee-modal').style.display='none'"></i><h3>মাসিক ফি নির্ধারণ</h3><div style="display:flex;gap:5px"><select id="fee-year"></select><input type="number" id="fee-amount" placeholder="টাকা"></div><button class="modern-btn" id="btn-save-fee">ফি সেভ করুন</button><div id="fee-list" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;"></div><button class="modern-btn" id="btn-recalc-all" style="background:#f59e0b;color:black; margin-top:20px">সবার ডিউ আপডেট করুন</button></div></div>
    <div id="due-list-modal" class="modal"><div class="modal-content"><i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('due-list-modal').style.display='none'"></i><h3>বকেয়া তালিকা</h3><div id="due-users-container"></div></div></div>
    <div id="due-details-modal" class="modal"><div class="modal-content"><i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('due-details-modal').style.display='none'"></i><h3 id="due-user-name-title" style="margin-bottom:15px; color:var(--primary)">বকেয়া বিস্তারিত</h3><div id="admin-due-total-header" style="background:#fef2f2; color:#dc2626; padding:12px; border:1px solid #fecaca; border-radius:8px; text-align:center; font-weight:bold; margin-bottom:15px;">মোট বাকি: ৳<span id="admin-due-modal-total">0</span></div><div id="due-months-list"></div></div></div>
    
    <div id="all-deposit-modal" class="modal">
        <div class="modal-content">
            <i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('all-deposit-modal').style.display='none'"></i>
            <h3>সদস্য ভিত্তিক জমা</h3>
            <div class="search-container">
                <input type="text" id="deposit-search-input" class="search-input" placeholder="নাম দিয়ে খুঁজুন...">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
            </div>
            <div id="deposit-members-list"></div>
        </div>
    </div>

    <div id="user-deposit-details-modal" class="modal">
        <div class="modal-content">
            <i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('user-deposit-details-modal').style.display='none'"></i>
            <h3 id="dep-user-title" style="margin-bottom:5px;">সদস্য নাম</h3>
            <div style="background:#e0f2f1; color:#00695c; padding:15px; border-radius:10px; text-align:center; font-weight:bold; margin-bottom:15px; border:1px solid #b2dfdb;">
                মোট জমা: ৳<span id="dep-user-total">0</span>
            </div>
            <div id="dep-history-list"></div>
        </div>
    </div>
    
    <div id="config-modal" class="modal"><div class="modal-content"><i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('config-modal').style.display='none'"></i><h3>সেটিংস</h3><label>অ্যাপ লোগো:</label><input type="file" id="app-logo-file"><label>সমিতির নাম:</label><input type="text" id="app-name-input"><button class="modern-btn" id="btn-save-config">সেভ</button></div></div>
    <div id="notice-modal" class="modal"><div class="modal-content"><i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('notice-modal').style.display='none'"></i><h3>চলমান নোটিশ</h3><textarea id="notice-text-input" rows="4" placeholder="এখানে নোটিশ লিখুন..."></textarea><button class="modern-btn" id="btn-save-notice">আপডেট করুন</button></div></div>
    
    <!-- Receipt Modal -->
    <div id="receipt-modal" class="modal">
        <div class="modal-content" style="padding:0; overflow:hidden;">
            <div id="receipt-box" style="background:#fff; padding:30px; color:#334155; position:relative; overflow:hidden;">
                <div style="text-align:center; margin-bottom:20px;">
                    <img id="rec-logo" src="https://i.ibb.co/5GzXk6n/logo.png" style="width:60px; height:60px; border-radius:50%; border:2px solid var(--primary); padding:2px; margin-bottom:5px;">
                    <h3 id="rec-org-name" style="margin:0; color:var(--primary); font-size:18px;">জনকল্যাণ সমিতি</h3>
                    <small style="background:#e0f2f1; color:var(--primary); padding:3px 10px; border-radius:15px; font-size:11px;">জমা রসিদ</small>
                </div>
                <div style="border-bottom:2px dashed #cbd5e1; margin-bottom:20px;"></div>
                <div style="font-size:13px; line-height:2.2;">
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #f1f5f9;"><span>নাম:</span> <b id="rec-name"></b></div>
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #f1f5f9;"><span>টাকার পরিমাণ:</span> <b style="color:var(--primary)">৳ <span id="rec-amount"></span></b></div>
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #f1f5f9;"><span>মাস ও সাল:</span> <b><span id="rec-month"></span> <span id="rec-year"></span></b></div>
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #f1f5f9;"><span>জমা তারিখ:</span> <span id="rec-date"></span></div>
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #f1f5f9;"><span>মাধ্যম:</span> <span id="rec-method"></span></div>
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #f1f5f9;"><span>মন্তব্য:</span> <span id="rec-note"></span></div>
                    <div style="display:flex; justify-content:space-between; margin-top:5px;"><span>স্ট্যাটাস:</span> <span style="background:#f0fdf4; color:#166534; padding:2px 8px; border-radius:4px; font-weight:bold; border:1px solid #bbf7d0; font-size:11px;">Approved</span></div>
                </div>
            </div>
            <div style="padding:20px; text-align:center; background:#f8fafc; display:flex; gap:10px;">
                <button class="modern-btn" id="btn-download-receipt" style="margin-top:0; flex:1"><i class="fa-solid fa-download"></i> ডাউনলোড</button>
                <button class="modern-btn" onclick="closeReceiptModal()" style="background:transparent; color:#64748b; border:1px solid #cbd5e1; margin-top:0; flex:1">বন্ধ করুন</button>
            </div>
        </div>
    </div>

    <div id="edit-member-modal" class="modal"><div class="modal-content"><i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('edit-member-modal').style.display='none'"></i><h3>সদস্য এডিট</h3><input type="hidden" id="edit-mem-id"><input type="text" id="edit-mem-name"><input type="text" id="edit-mem-phone"><button class="modern-btn" id="btn-save-member">আপডেট</button></div></div>
    <div id="rules-modal" class="modal"><div class="modal-content"><i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('rules-modal').style.display='none'"></i><h3>নিয়মাবলী সেটআপ</h3><textarea id="rules-text" rows="8"></textarea><button class="modern-btn" id="btn-save-rules">পোস্ট করুন</button></div></div>
    <div id="decisions-modal" class="modal"><div class="modal-content"><i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('decisions-modal').style.display='none'"></i><h3>সিদ্ধান্ত গ্রহণ</h3><input type="text" id="decision-title" placeholder="বিষয়"><textarea id="decision-desc" rows="4" placeholder="বিস্তারিত সিদ্ধান্ত..."></textarea><input type="date" id="decision-date"><button class="modern-btn" id="btn-post-decision" style="background:#4f46e5">প্রকাশ করুন</button><h4 style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">পূর্ববর্তী সিদ্ধান্তসমূহ</h4><div id="admin-decisions-list"></div></div></div>

    <div id="extra-fee-setup-modal" class="modal">
        <div class="modal-content">
            <i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('extra-fee-setup-modal').style.display='none'"></i>
            <h3>অতিরিক্ত ফি নির্ধারণ</h3>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <select id="ex-setup-year"></select>
                <input type="text" id="ex-setup-title" placeholder="খাত (যেমন: ঈদুল ফিতর)">
            </div>
            <input type="number" id="ex-setup-amount" placeholder="টাকার পরিমাণ">
            <button class="modern-btn" id="btn-save-extra-fee">আপডেট করুন</button>
            <h4 style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">নির্ধারিত ফিসমূহ</h4>
            <div id="extra-fee-list-container"></div>
            <button class="modern-btn" id="btn-recalc-all-extra" style="background:#f59e0b; color:black; margin-top:20px">সকল সদস্যের ডিউ আপডেট করুন</button>
        </div>
    </div>

    <div id="extra-collection-modal" class="modal">
        <div class="modal-content">
            <i class="fa-solid fa-xmark modal-close-icon" onclick="document.getElementById('extra-collection-modal').style.display='none'"></i>
            <h3>অতিরিক্ত ফি আদায়</h3>
            <select id="ex-coll-name"><option>সদস্য সিলেক্ট করুন</option></select>
            <div style="display:flex; gap:5px; margin-top:8px;">
                <select id="ex-coll-year"></select>
                <select id="ex-coll-title"><option>ফি সিলেক্ট করুন</option></select>
            </div>
            <label style="font-size:12px; margin-top:5px; display:block">টাকার পরিমাণ (অটো):</label>
            <input type="number" id="ex-coll-amount" placeholder="টাকা">
            <label style="font-size:12px">জমার তারিখ:</label>
            <input type="date" id="ex-coll-date">
            <select id="ex-coll-method"><option>Cash</option><option>Bkash</option><option>Nagad</option></select>
            <button class="modern-btn" id="btn-submit-extra-coll">জমা নিশ্চিত করুন</button>
        </div>
    </div>

    <div id="admin-chat-modal" class="modal">
        <div class="modal-content" style="padding:0; height:85vh; border-radius:20px; overflow:hidden; background:#e5ddd5; display:flex; flex-direction:column;">
            <div style="background:var(--primary); color:white; padding:15px; display:flex; align-items:center; gap:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1)">
                <img id="chat-header-img" src="https://i.ibb.co/5GzXk6n/logo.png" style="width:40px; height:40px; border-radius:50%; background:white; padding:2px;">
                <div style="flex:1"><h4 id="chat-user-title" style="margin:0; font-size:16px;">সদস্য নাম</h4><small style="opacity:0.8; font-size:11px;">মেসেজ করুন</small></div>
                <i class="fa-solid fa-trash-can" id="btn-clear-chat" title="Clear Chat" style="font-size:18px; cursor:pointer; margin-right:15px; color:#ffcdd2;"></i>
                <i class="fa-solid fa-xmark" style="font-size:20px; cursor:pointer" onclick="document.getElementById('admin-chat-modal').style.display='none'"></i>
            </div>
            <div id="admin-chat-body" class="chat-body"></div>
            <div class="chat-footer">
                <label for="adm-chat-file" class="chat-btn-attach"><i class="fa-solid fa-paperclip"></i></label>
                <input type="file" id="adm-chat-file" style="display:none">
                <textarea id="adm-chat-text" class="chat-input" rows="1" placeholder="রিপ্লাই লিখুন..."></textarea>
                <button class="chat-btn-send" id="btn-adm-send-chat"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, updateDoc, doc, addDoc, increment, deleteDoc, getDoc, setDoc, deleteField, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        const firebaseConfig = { apiKey: "AIzaSyD_cBqn-vmdEyqczFnDgjAZ8R4lzKrRCvs", authDomain: "sfa-smiti.firebaseapp.com", projectId: "sfa-smiti", storageBucket: "sfa-smiti.firebasestorage.app", messagingSenderId: "916634119266", appId: "1:916634119266:web:c58e818ee488cf1663753b" };
        const app = initializeApp(firebaseConfig); 
        const db = getFirestore(app); 
        const auth = getAuth(app); 
        const imgbbAPI = "0e75c16cdb6ffd2bd5249dd1f69783e8";

        // --- AUTH & LOGIN LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-admin-panel').style.display = 'flex';
                } else {
                    await signOut(auth);
                    showLoginError("আপনি অ্যাডমিন নন!");
                }
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('main-admin-panel').style.display = 'none';
            }
        });

        document.getElementById('btn-login-submit').onclick = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            if(!email || !pass) return showLoginError("সব ঘর পূরণ করুন!");
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                showLoginError("ইমেইল বা পাসওয়ার্ড ভুল!");
            }
        };

        function showLoginError(msg) {
            const err = document.getElementById('login-error-msg');
            err.innerText = msg; err.style.display = 'block';
            setTimeout(() => { err.style.display = 'none'; }, 3000);
        }

        document.getElementById('logout-btn').onclick = () => { if(confirm("লগ আউট করবেন?")) signOut(auth); };

        // --- YOUR ORIGINAL SCRIPT STARTS HERE ---
        let chatUnsubscribe = null; 
        let activeEntryModal = null;
        let loadedFees = {}; 

        async function loadConfig() { const d=await getDoc(doc(db,"config","appSettings")); if(d.exists()){ if(d.data().logo) { document.getElementById('admin-logo-view').src=d.data().logo; document.getElementById('login-logo-img').src=d.data().logo; } if(d.data().name) { document.getElementById('admin-title-view').innerText=d.data().name; document.getElementById('login-org-name').innerText=d.data().name; } } } loadConfig();
        const py=(i)=>{const s=document.getElementById(i);if(s){s.innerHTML='';for(let x=2020;x<=2040;x++){let o=document.createElement('option');o.text=x;s.add(o)}s.value=new Date().getFullYear()}};py('entry-year');py('fee-year');py('ex-setup-year');py('ex-coll-year'); py('fine-coll-year');
        
        async function loadStats() {
            const approvedDeposits = await getDocs(query(collection(db, "deposits"), where("status", "==", "approved")));
            let mainFund = 0;
            let fineCollected = 0;
            const paidMonthsMap = {};

            approvedDeposits.forEach(d => {
                const data = d.data();
                if (data.type === 'fine') {
                    fineCollected += parseInt(data.amount || 0);
                } else {
                    mainFund += parseInt(data.amount || 0);
                }
                if (!paidMonthsMap[data.uid]) paidMonthsMap[data.uid] = new Set();
                paidMonthsMap[data.uid].add(`${data.month}-${data.year}`);
            });

            const usersSnap = await getDocs(collection(db, "users"));
            const feesDoc = await getDoc(doc(db, "config", "fees"));
            const fees = feesDoc.exists() ? feesDoc.data() : {};
            const fineDoc = await getDoc(doc(db, "config", "fineSettings"));
            const fineConfig = fineDoc.exists() ? fineDoc.data() : { lateDate: 10, amount: 0 };
            
            let memberCount = 0;
            let totalDue = 0;
            let fineOutstanding = 0;
            let currentDate = new Date();
            let currentDay = currentDate.getDate();

            usersSnap.forEach(u => {
                const ud = u.data();
                if (ud.role !== 'admin' && ud.status === 'approved') {
                    memberCount++;
                    const d = ud.totalDue || 0;
                    if (d > 0) totalDue += d;

                    const paidSet = paidMonthsMap[u.id] || new Set();
                    for (let y = 2020; y <= currentDate.getFullYear(); y++) {
                        if (fees[y]) {
                            for (let m = 0; m < 12; m++) {
                                if (y == currentDate.getFullYear() && m > currentDate.getMonth()) break;
                                let mn = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"][m];
                                if (!paidSet.has(`${mn}-${y}`)) {
                                    if (y < currentDate.getFullYear() || (y == currentDate.getFullYear() && m < currentDate.getMonth()) || (y == currentDate.getFullYear() && m == currentDate.getMonth() && currentDay > fineConfig.lateDate)) {
                                        if (fineConfig.amount > 0) fineOutstanding += parseInt(fineConfig.amount);
                                    }
                                }
                            }
                        }
                    }
                }
            });

            document.getElementById('adm-mem').innerText = memberCount;
            document.getElementById('adm-total').innerText = mainFund;
            document.getElementById('adm-due').innerText = totalDue;
            document.getElementById('adm-fine-due').innerText = fineOutstanding;
            document.getElementById('adm-fine-coll').innerText = fineCollected;
        }
        loadStats();
        
        async function getExp(){
            const d=await getDoc(doc(db,"config","fees"));
            const f=d.exists()?d.data():{};
            const exD=await getDoc(doc(db,"config","extraFees"));
            const exF=exD.exists()?exD.data():{};
            let t=0,n=new Date();
            for(let y=2020;y<=n.getFullYear();y++){let m=12;if(y===n.getFullYear())m=n.getMonth()+1;t+=((f[y]||0)*m);}
            Object.values(exF).forEach(fee=>{if(parseInt(fee.year)<=n.getFullYear())t+=parseInt(fee.amount)});
            return t;
        }

        async function updateUserDue(uid){const u=(await getDoc(doc(db,"users",uid))).data();const e=await getExp();await updateDoc(doc(db,"users",uid),{totalDue:e-(u.totalDeposit||0)});}

        window.uA=async(id,a)=>{if(confirm(a==='approved'?"সদস্য এপ্রুভ করবেন?":"বাতিল করবেন?")){if(a==='approved'){await updateDoc(doc(db,"users",id),{status:'approved'});const e=await getExp();await updateDoc(doc(db,"users",id),{totalDue:e});alert("এপ্রুভ সফল")}else{await deleteDoc(doc(db,"users",id));alert("বাতিল সফল")}location.reload()}};
        window.apprDep=async(id,uid,amt)=>{if(confirm("জমা এপ্রুভ করবেন?")){await updateDoc(doc(db,"deposits",id),{status:'approved'});await updateDoc(doc(db,"users",uid),{totalDeposit:increment(amt)});await updateUserDue(uid);location.reload()}};
        window.rejDep=async(id)=>{if(confirm("জমা বাতিল করবেন?")){await updateDoc(doc(db,"deposits",id),{status:'rejected'});location.reload()}};
        window.del=async(id,uid,amt)=>{if(confirm("এই জমা ডিলিট করবেন? এতে ইউজারের ব্যালেন্স কমে যাবে।")){await deleteDoc(doc(db,"deposits",id));await updateDoc(doc(db,"users",uid),{totalDeposit:increment(-amt)});await updateUserDue(uid);alert("ডিলিট সফল");location.reload()}};
        window.delMem=async(id)=>{if(confirm("সদস্য ডিলিট করবেন? তার সকল ডাটা কিন্তু থাকবে, সে নতুন পিন দিয়ে আবার রেজিস্ট্রেশন করতে পারবে।")){await deleteDoc(doc(db,"users",id));alert("সদস্য ডিলিট সফল");location.reload()}};
        window.editMem=(id,n,p)=>{document.getElementById('edit-member-modal').style.display='flex';document.getElementById('edit-mem-id').value=id;document.getElementById('edit-mem-name').value=n;document.getElementById('edit-mem-phone').value=p};

        document.getElementById('member-search-input').addEventListener('input', function(e) {
            const searchText = e.target.value.toLowerCase();
            const cards = document.querySelectorAll('#member-list-container .smart-card');
            cards.forEach(card => {
                const text = card.innerText.toLowerCase();
                card.style.display = text.includes(searchText) ? 'flex' : 'none';
            });
        });

        let currentChatUser = null;
        window.openChat = async (uid, name, photo) => {
            currentChatUser = uid;
            document.getElementById('admin-chat-modal').style.display = 'flex';
            document.getElementById('chat-user-title').innerText = name;
            document.getElementById('chat-header-img').src = photo || "https://i.ibb.co/5GzXk6n/logo.png";
            loadAdminChat(uid);
        };
        window.deleteSingleMsg = async (docId) => { if(confirm("এই মেসেজটি ডিলিট করবেন?")) { try { await deleteDoc(doc(db, "complaints", docId)); } catch(e) { console.error(e); } } };
        document.getElementById('btn-clear-chat').onclick = async () => { if(!currentChatUser) return; if(confirm("সব চ্যাট ডিলিট করবেন?")) { try { const q = query(collection(db, "complaints"), where("uid", "==", currentChatUser)); const s = await getDocs(q); s.forEach(async d => await deleteDoc(d.ref)); alert("চ্যাট ক্লিয়ার"); } catch(e) { alert("সমস্যা হয়েছে"); } } };
        function loadAdminChat(uid) {
            if(chatUnsubscribe) chatUnsubscribe();
            const box = document.getElementById('admin-chat-body');
            box.innerHTML = '<p style="text-align:center; font-size:12px; color:#999; margin-top:20px;">মেসেজ লোড হচ্ছে...</p>';
            const q = query(collection(db, "complaints"), where("uid", "==", uid), orderBy("timestamp", "asc"));
            chatUnsubscribe = onSnapshot(q, (snapshot) => {
                box.innerHTML = '';
                if(snapshot.empty) { box.innerHTML = '<div style="text-align:center; margin-top:50px; opacity:0.6"><i class="fa-regular fa-comments" style="font-size:40px; color:#ccc;"></i><p style="font-size:13px;">কোনো মেসেজ নেই</p></div>'; return; }
                snapshot.forEach(doc => {
                    const d = doc.data();
                    let imgHtml = d.photoUrl ? `<img src="${d.photoUrl}" class="chat-img-preview" onclick="window.open(this.src)">` : '';
                    let bubbleClass = d.byAdmin ? 'bubble-admin' : 'bubble-user';
                    if(!d.byAdmin && d.status !== 'read') { updateDoc(doc.ref, { status: 'read' }); }
                    let tickIcon = ''; if(d.byAdmin) { tickIcon = d.status === 'read' ? '<i class="fa-solid fa-check-double chat-tick seen"></i>' : '<i class="fa-solid fa-check chat-tick"></i>'; }
                    let deleteIcon = `<i class="fa-solid fa-trash delete-msg-btn" onclick="deleteSingleMsg('${doc.id}')"></i>`;
                    box.innerHTML += `<div class="chat-bubble ${bubbleClass}">${imgHtml}<div>${d.text}</div><div class="chat-meta"><span class="chat-time">${d.date}</span>${deleteIcon}${tickIcon}</div></div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }
        document.getElementById('admin-chat-modal').onclick = (e) => { if(e.target === document.getElementById('admin-chat-modal')) { document.getElementById('admin-chat-modal').style.display='none'; if(chatUnsubscribe) chatUnsubscribe(); } };
        document.getElementById('btn-adm-send-chat').onclick = async () => {
            if(!currentChatUser) return;
            const txt = document.getElementById('adm-chat-text').value;
            const file = document.getElementById('adm-chat-file').files[0];
            if(!txt && !file) return;
            const btn = document.getElementById('btn-adm-send-chat');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.disabled = true;
            let photoUrl = "";
            if (file) {
                try {
                    const fm = new FormData(); fm.append("image", file);
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbAPI}`, { method: "POST", body: fm });
                    const data = await res.json();
                    if(data.data && data.data.url) { photoUrl = data.data.url; } 
                    else { alert("ছবি আপলোড ব্যর্থ হয়েছে"); btn.innerHTML = originalIcon; btn.disabled = false; return; }
                } catch(e) { console.error("Img Upload Error:", e); alert("ছবি আপলোডে সমস্যা"); btn.innerHTML = originalIcon; btn.disabled = false; return; }
            }
            await addDoc(collection(db, "complaints"), { uid: currentChatUser, text: txt, photoUrl: photoUrl, date: new Date().toLocaleDateString('bn-BD'), timestamp: serverTimestamp(), byAdmin: true, status: 'sent' });
            document.getElementById('adm-chat-text').value = ''; document.getElementById('adm-chat-file').value = '';
            btn.innerHTML = originalIcon; btn.disabled = false;
        };

        window.deleteDecision = async (id) => { if(confirm("ডিলিট করবেন?")) { await deleteDoc(doc(db, "decisions", id)); document.getElementById('btn-decisions').click(); } };
        document.getElementById('btn-decisions').onclick = async () => { document.getElementById('decisions-modal').style.display='flex'; document.getElementById('decision-date').valueAsDate = new Date(); const list = document.getElementById('admin-decisions-list'); list.innerHTML = 'লোড হচ্ছে...'; const s = await getDocs(query(collection(db, "decisions"), orderBy("timestamp", "desc"))); list.innerHTML = ''; if(s.empty) list.innerHTML = '<p style="text-align:center">কোনো সিদ্ধান্ত নেই</p>'; s.forEach(d => { const m = d.data(); list.innerHTML += `<div class="smart-card" style="display:block; border-left:4px solid #4f46e5;"><div style="display:flex; justify-content:space-between"><b>${m.title}</b><button onclick="deleteDecision('${d.id}')" style="background:red; color:white; border:none; padding:2px 8px; border-radius:4px; cursor:pointer"><i class="fa-solid fa-trash"></i></button></div><div style="font-size:12px; margin-top:5px; color:#64748b;">${m.date}</div><div style="font-size:13px; margin-top:5px; white-space:pre-wrap;">${m.description}</div></div>`; }); };
        document.getElementById('btn-post-decision').onclick = async () => { const t = document.getElementById('decision-title').value; const d = document.getElementById('decision-desc').value; const dt = document.getElementById('decision-date').value; if(!t || !d) return alert("তথ্য দিন"); await addDoc(collection(db, "decisions"), { title: t, description: d, date: dt, timestamp: serverTimestamp() }); alert("প্রকাশিত হয়েছে"); document.getElementById('decision-title').value = ''; document.getElementById('decision-desc').value = ''; document.getElementById('btn-decisions').click(); };
        
        window.deleteMeeting = async (id) => { if(confirm("মিটিং ডিলিট করবেন?")) { await deleteDoc(doc(db, "meetings", id)); alert("ডিলিট হয়েছে"); document.getElementById('btn-meeting-admin').click(); } };
        document.getElementById('btn-meeting-admin').onclick=async()=>{ document.getElementById('meeting-modal').style.display='flex'; const l = document.getElementById('admin-meeting-list'); l.innerHTML = 'লোড হচ্ছে...'; try { const s = await getDocs(query(collection(db, "meetings"), orderBy("createdAt", "desc"))); l.innerHTML = ''; if(s.empty) l.innerHTML = '<p style="text-align:center">কোনো মিটিং নেই</p>'; s.forEach(d => { const m = d.data(); l.innerHTML += `<div class="smart-card" style="display:block;"><div style="display:flex; justify-content:space-between"><b>${m.date} (${m.day})</b><button onclick="deleteMeeting('${d.id}')" style="background:red; color:white; border:none; padding:2px 8px; border-radius:4px; cursor:pointer"><i class="fa-solid fa-trash"></i></button></div><div style="font-size:12px; margin-top:5px;">সময়: ${m.time}</div><div style="font-size:12px;">উদ্দেশ্য: ${m.purpose}</div></div>`; }); } catch(e) { console.log(e); } };
        document.getElementById('btn-save-meeting').onclick = async () => { const date = document.getElementById('meeting-date').value; const time = document.getElementById('meeting-time').value; const purpose = document.getElementById('meeting-purpose').value; if(!date || !time || !purpose) return alert("সব তথ্য দিন"); const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']; const dayName = days[new Date(date).getDay()]; await addDoc(collection(db, "meetings"), { date, day: dayName, time, purpose, createdAt: serverTimestamp() }); alert("মিটিং শিডিউল পোস্ট হয়েছে"); document.getElementById('meeting-purpose').value = ''; document.getElementById('btn-meeting-admin').click(); };

        window.showDue = async (uid, name) => { document.getElementById('due-details-modal').style.display = 'flex'; document.getElementById('due-user-name-title').innerText = name + " - বকেয়া"; const l = document.getElementById('due-months-list'); const totalDisplay = document.getElementById('admin-due-modal-total'); l.innerHTML = '<div style="text-align:center; padding:20px;">হিসাব করা হচ্ছে...</div>'; totalDisplay.innerText = "0"; try { const feesDoc = await getDoc(doc(db, "config", "fees")); const fees = feesDoc.data() || {}; const exFeesDoc = await getDoc(doc(db, "config", "extraFees")); const extraFees = exFeesDoc.exists() ? exFeesDoc.data() : {}; const depositsSnap = await getDocs(query(collection(db, "deposits"), where("uid", "==", uid), where("status", "==", "approved"))); const paidItems = new Set(); depositsSnap.forEach(d => { paidItems.add(`${d.data().month}-${d.data().year}`); }); l.innerHTML = ''; let totalDue = 0; let currentDate = new Date(); for (let y = 2020; y <= currentDate.getFullYear(); y++) { if (fees[y]) { for (let m = 0; m < 12; m++) { if (y == currentDate.getFullYear() && m > currentDate.getMonth()) break; let mn = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"][m]; if (!paidItems.has(`${mn}-${y}`)) { totalDue += fees[y]; l.innerHTML += ` <div class="smart-card" style="border-left:4px solid #dc2626"> <span style="font-weight:500; font-size:14px; color:#334155">${mn} ${y}</span> <span style="font-weight:700; color:#dc2626">৳${fees[y]}</span> </div>`; } } } } Object.values(extraFees).forEach(f => { if (parseInt(f.year) <= currentDate.getFullYear()) { if (!paidItems.has(`${f.title}-${f.year}`)) { totalDue += parseInt(f.amount); l.innerHTML += `<div class="smart-card" style="border-left:4px solid #9333ea"><span style="color:#334155">${f.title} (${f.year})</span><span style="font-weight:700; color:#9333ea">৳${f.amount}</span></div>`; } } }); totalDisplay.innerText = totalDue; if (l.innerHTML === '') l.innerHTML = '<p style="text-align:center; color:#059669; font-weight:500; padding:20px; background:#f0fdf4; border-radius:10px;">কোনো বকেয়া নেই।</p>'; } catch (e) { l.innerHTML = '<p style="text-align:center; color:red">তথ্য লোড করতে সমস্যা হয়েছে</p>'; } };
        
        window.editFee = (year, amount) => { document.getElementById('fee-year').value = year; document.getElementById('fee-amount').value = amount; };
        window.deleteFee = async (year) => { if(confirm(`${year} সালের ফি ডিলিট করবেন?`)) { await updateDoc(doc(db,"config","fees"), { [year]: deleteField() }); alert("ডিলিট হয়েছে"); document.getElementById('btn-monthly-fee').click(); } };
        document.getElementById('btn-monthly-fee').onclick=async()=>{ document.getElementById('fee-modal').style.display='flex'; const l=document.getElementById('fee-list');l.innerHTML='লোড হচ্ছে...'; const d=await getDoc(doc(db,"config","fees")); l.innerHTML=''; if(d.exists()){ const f=d.data(); Object.keys(f).sort().forEach(k=>{ l.innerHTML+=` <div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee; align-items:center;"> <span style="font-weight:500;">${k} সাল - ৳${f[k]}</span> <div> <button onclick="editFee('${k}', ${f[k]})" style="background:#eab308;color:black;border:none;padding:5px 8px;border-radius:5px;cursor:pointer;margin-right:5px;"><i class="fa-solid fa-pen"></i></button> <button onclick="deleteFee('${k}')" style="background:#dc2626;color:white;border:none;padding:5px 8px;border-radius:5px;cursor:pointer;"><i class="fa-solid fa-trash"></i></button> </div> </div>`; }) } };
        document.getElementById('btn-save-fee').onclick=async()=>{ const y=document.getElementById('fee-year').value, a=parseInt(document.getElementById('fee-amount').value); if(!a) return alert("টাকার পরিমাণ দিন"); await setDoc(doc(db,"config","fees"),{[y]:a},{merge:true}); alert("সেভ হয়েছে"); document.getElementById('btn-monthly-fee').click(); };
        document.getElementById('btn-notice').onclick=async()=>{ document.getElementById('notice-modal').style.display='flex'; const d=await getDoc(doc(db,"config","appSettings")); if(d.exists()) document.getElementById('notice-text-input').value = d.data().notice || ""; };
        document.getElementById('btn-save-notice').onclick=async()=>{ const txt = document.getElementById('notice-text-input').value; await setDoc(doc(db,"config","appSettings"), { notice: txt }, { merge: true }); alert("নোটিশ আপডেট হয়েছে"); document.getElementById('notice-modal').style.display='none'; };
        const daySelect = document.getElementById('fine-late-date'); for (let i=1; i<=31; i++) { let op = document.createElement('option'); op.value = i; op.text = i + " তারিখ"; daySelect.appendChild(op); }
        document.getElementById('btn-fine-management').onclick=async()=>{ document.getElementById('fine-modal').style.display='flex'; const conf = await getDoc(doc(db, "config", "fineSettings")); if(conf.exists()) { document.getElementById('fine-late-date').value = conf.data().lateDate || 10; document.getElementById('fine-amount').value = conf.data().amount || 0; } const l = document.getElementById('all-users-fine-list'); l.innerHTML = 'লোড হচ্ছে...'; try { const fineConfig = conf.exists() ? conf.data() : { lateDate: 10, amount: 0 }; const feesDoc = await getDoc(doc(db, "config", "fees")); const fees = feesDoc.exists() ? feesDoc.data() : {}; const usersSnap = await getDocs(collection(db, "users")); const depositsSnap = await getDocs(query(collection(db, "deposits"), where("status", "==", "approved"))); const userPaidMonths = {}; depositsSnap.forEach(d => { const uid = d.data().uid; if(!userPaidMonths[uid]) userPaidMonths[uid] = new Set(); userPaidMonths[uid].add(`${d.data().month}-${d.data().year}`); }); l.innerHTML = ''; let currentDate = new Date(); let currentDay = currentDate.getDate(); usersSnap.forEach(u => { if (u.data().status == 'approved' && u.data().role !== 'admin') { let userFine = 0; const paidSet = userPaidMonths[u.id] || new Set(); for (let y = 2020; y <= currentDate.getFullYear(); y++) { if (fees[y]) { for (let m = 0; m < 12; m++) { if (y == currentDate.getFullYear() && m > currentDate.getMonth()) break; let mn = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"][m]; if (!paidSet.has(`${mn}-${y}`)) { if (y < currentDate.getFullYear() || (y == currentDate.getFullYear() && m < currentDate.getMonth()) || (y == currentDate.getFullYear() && m == currentDate.getMonth() && currentDay > fineConfig.lateDate)) { if(fineConfig.amount > 0) userFine += parseInt(fineConfig.amount); } } } } } if(userFine > 0) { l.innerHTML += `<div class="smart-card"><b>${u.data().name}</b><span style="color:#c2410c; font-weight:bold;">৳${userFine}</span></div>`; } } }); if(l.innerHTML == '') l.innerHTML = '<p style="text-align:center; color:green">কারো জরিমানা নেই</p>'; } catch(e) { console.error(e); } };
        document.getElementById('btn-save-fine-config').onclick=async()=>{ const d = parseInt(document.getElementById('fine-late-date').value); const a = parseInt(document.getElementById('fine-amount').value); await setDoc(doc(db, "config", "fineSettings"), { lateDate: d, amount: a }, { merge: true }); alert("সেটিংস সেভ হয়েছে"); document.getElementById('btn-fine-management').click(); };
        document.getElementById('btn-approv').onclick=async()=>{document.getElementById('approv-modal').style.display='flex';const c=document.getElementById('req-list-container');c.innerHTML='...';const s=await getDocs(query(collection(db,"users"),where("status","==","pending")));c.innerHTML='';if(s.empty)c.innerHTML='<p style="text-align:center">কোনো রিকুয়েস্ট নেই</p>';s.forEach(d=>{const u=d.data();c.innerHTML+=`<div class="smart-card"><div style="display:flex;align-items:center;gap:10px"><img src="${u.photoUrl}" style="width:40px;height:40px;border-radius:50%"><div><b>${u.name}</b><br>${u.phone}</div></div><div><button class="approve-btn" onclick="uA('${d.id}','approved')"><i class="fa-solid fa-check"></i></button> <button class="reject-btn" onclick="uA('${d.id}','rejected')"><i class="fa-solid fa-times"></i></button></div></div>`})};
        document.getElementById('btn-deposit-req').onclick=async()=>{document.getElementById('deposit-approv-modal').style.display='flex';const c=document.getElementById('deposit-req-list');c.innerHTML='...';const s=await getDocs(query(collection(db,"deposits"),where("status","==","pending")));c.innerHTML='';if(s.empty)c.innerHTML='<p style="text-align:center">কোনো রিকুয়েস্ট নেই</p>';s.forEach(d=>{const t=d.data();c.innerHTML+=`<div class="smart-card"><div><b>${t.name}</b><br>৳${t.amount} (${t.method})<br><small>${t.month} ${t.year}</small></div><div><button class="approve-btn" onclick="apprDep('${d.id}','${t.uid}',${t.amount})"><i class="fa-solid fa-check"></i></button> <button class="reject-btn" onclick="rejDep('${d.id}')"><i class="fa-solid fa-times"></i></button></div></div>`})};
        
        document.getElementById('btn-member-list').onclick=async()=>{
            document.getElementById('member-list-modal').style.display='flex';
            const c=document.getElementById('member-list-container');
            c.innerHTML='লোড হচ্ছে...';
            try {
                const s = await getDocs(collection(db,"users"));
                c.innerHTML='';
                let ct=0;
                s.forEach(d=>{
                    const u=d.data();
                    if(u.role!=='admin'){
                        ct++;
                        c.innerHTML+=`<div class="smart-card"><div style="display:flex;align-items:center;gap:10px; flex:1"><img src="${u.photoUrl||'https://i.ibb.co/5GzXk6n/logo.png'}" style="width:40px;height:40px;border-radius:50%; border:2px solid #ddd; object-fit:cover;"><div><b>${u.name}</b><br><small style="color:#64748b">${u.phone}</small></div></div><div style="display:flex; gap:5px;"><button style="background:#f59e0b;color:black;border:none;padding:8px 10px;border-radius:5px;cursor:pointer" onclick="editMem('${d.id}','${u.name}','${u.phone}')"><i class="fa-solid fa-pen"></i></button><button style="background:#dc2626;color:white;border:none;padding:8px 10px;border-radius:5px;cursor:pointer" onclick="delMem('${d.id}')"><i class="fa-solid fa-trash"></i></button></div></div>`;
                    }
                });
                document.getElementById('total-mem-count').innerText=ct;
            } catch(e) { console.log(e); }
        };

        document.getElementById('btn-complaint-inbox').onclick=async()=>{
            document.getElementById('complaint-inbox-modal').style.display='flex';
            const c=document.getElementById('complaint-inbox-list');
            c.innerHTML='লোড হচ্ছে...';
            try {
                const s = await getDocs(collection(db,"users"));
                const complaintsSnap = await getDocs(collection(db, "complaints"));
                const activeChatUsers = new Set();
                complaintsSnap.forEach(doc => { activeChatUsers.add(doc.data().uid); });
                c.innerHTML='';
                if(activeChatUsers.size === 0) { c.innerHTML = '<p style="text-align:center">কোনো মেসেজ নেই</p>'; return; }
                s.forEach(d=>{
                    const u=d.data();
                    if(activeChatUsers.has(d.id)){
                         c.innerHTML+=`<div class="smart-card" onclick="openChat('${d.id}', '${u.name}', '${u.photoUrl}')" style="cursor:pointer"><div style="display:flex;align-items:center;gap:10px;"><img src="${u.photoUrl||'https://i.ibb.co/5GzXk6n/logo.png'}" style="width:40px;height:40px;border-radius:50%; object-fit:cover;"><div><b>${u.name}</b><br><small style="color:#64748b">মেসেজ দেখুন</small></div></div><i class="fa-solid fa-chevron-right" style="color:#ccc"></i></div>`;
                    }
                });
            } catch(e) { console.log(e); }
        };

        document.getElementById('btn-extra-fee-setup').onclick = async () => {
            document.getElementById('extra-fee-setup-modal').style.display = 'flex';
            loadExtraFeeList();
        };

        async function loadExtraFeeList() {
            const c = document.getElementById('extra-fee-list-container');
            c.innerHTML = 'লোড হচ্ছে...';
            const d = await getDoc(doc(db, "config", "extraFees"));
            c.innerHTML = '';
            if (d.exists()) {
                const fees = d.data();
                const sortedKeys = Object.keys(fees).sort((a, b) => fees[b].year - fees[a].year);
                sortedKeys.forEach(key => {
                    const f = fees[key];
                    c.innerHTML += `<div class="smart-card" style="display:flex; justify-content:space-between; align-items:center;"><div><b>${f.title}</b> <small>(${f.year})</small><div style="color:var(--primary); font-weight:bold;">৳${f.amount}</div></div><button onclick="deleteExtraFee('${key}')" style="background:#dc2626; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;"><i class="fa-solid fa-trash"></i></button></div>`;
                });
            } else { c.innerHTML = '<p style="text-align:center">কোনো ফি নেই</p>'; }
        }

        document.getElementById('btn-save-extra-fee').onclick = async () => {
            const y = document.getElementById('ex-setup-year').value;
            const t = document.getElementById('ex-setup-title').value.trim();
            const a = parseInt(document.getElementById('ex-setup-amount').value);
            if (!y || !t || !a) return alert("সব তথ্য দিন");
            const id = `${y}_${t.replace(/\s+/g, '_')}`;
            await setDoc(doc(db, "config", "extraFees"), { [id]: { year: y, title: t, amount: a, createdAt: new Date() } }, { merge: true });
            alert("আপডেট হয়েছে");
            document.getElementById('ex-setup-title').value = '';
            document.getElementById('ex-setup-amount').value = '';
            loadExtraFeeList();
        };

        window.deleteExtraFee = async (key) => { if(confirm("এই ফি ডিলিট করবেন?")) { await updateDoc(doc(db, "config", "extraFees"), { [key]: deleteField() }); loadExtraFeeList(); } };
        document.getElementById('btn-recalc-all-extra').onclick = async () => {if(!confirm("ডিউ আপডেট করবেন?"))return; const e=await getExp(); const s=await getDocs(collection(db,"users")); s.forEach(d=>{if(d.data().role!=='admin')updateDoc(doc(db,"users",d.id),{totalDue:e-(d.data().totalDeposit||0)})}); alert("আপডেট হয়েছে");};

        document.getElementById('btn-extra-collection').onclick = async () => {
            document.getElementById('extra-collection-modal').style.display = 'flex';
            document.getElementById('ex-coll-date').valueAsDate = new Date();
            const s = document.getElementById('ex-coll-name');
            s.innerHTML = '<option>সদস্য সিলেক্ট করুন</option>';
            (await getDocs(collection(db, "users"))).forEach(d => { if (d.data().status == 'approved' && d.data().role !== 'admin') { s.innerHTML += `<option value="${d.id}">${d.data().name}</option>`; } });
            const fs = document.getElementById('ex-coll-title');
            fs.innerHTML = '<option value="">ফি সিলেক্ট করুন</option>';
            const d = await getDoc(doc(db, "config", "extraFees"));
            if(d.exists()) {
                const fees = d.data();
                Object.keys(fees).forEach(key => { const f = fees[key]; fs.innerHTML += `<option value="${f.title}" data-amount="${f.amount}" data-year="${f.year}">${f.title} - ${f.year} (৳${f.amount})</option>`; });
            }
        };

        document.getElementById('ex-coll-title').onchange = (e) => { const opt = e.target.options[e.target.selectedIndex]; if(opt.dataset.amount) { document.getElementById('ex-coll-amount').value = opt.dataset.amount; document.getElementById('ex-coll-year').value = opt.dataset.year; } };

        document.getElementById('btn-submit-extra-coll').onclick = async () => {
            const btn = document.getElementById('btn-submit-extra-coll');
            const uid = document.getElementById('ex-coll-name').value;
            const title = document.getElementById('ex-coll-title').value;
            const amt = parseInt(document.getElementById('ex-coll-amount').value);
            const year = document.getElementById('ex-coll-year').value;
            const date = document.getElementById('ex-coll-date').value;
            if (uid === 'সদস্য সিলেক্ট করুন' || !title || !amt) return alert("তথ্য দিন");
            if (confirm("জমা নিশ্চিত করবেন?")) {
                const nm = document.getElementById('ex-coll-name').options[document.getElementById('ex-coll-name').selectedIndex].text;
                await addDoc(collection(db, "deposits"), { uid, name: nm, amount: amt, month: title, year: year, method: document.getElementById('ex-coll-method').value, note: "Extra Fee", depositDate: date, status: 'approved', isExtra: true, date: new Date(), submittedBy: 'admin' });
                await updateDoc(doc(db, "users", uid), { totalDeposit: increment(amt) });
                await updateUserDue(uid);
                activeEntryModal = 'extra-collection-modal';
                document.getElementById('extra-collection-modal').style.display = 'none';
                document.getElementById('receipt-modal').style.display = 'flex';
                document.getElementById('rec-name').innerText = nm; document.getElementById('rec-amount').innerText = amt; document.getElementById('rec-month').innerText = `${title} ${year}`; document.getElementById('rec-date').innerText = date; document.getElementById('rec-method').innerText = document.getElementById('ex-coll-method').value; document.getElementById('rec-note').innerText = "Extra Fee";
                loadStats();
            }
        };
        
        document.getElementById('btn-fine-collection').onclick = async () => {
            document.getElementById('fine-collection-modal').style.display = 'flex';
            document.getElementById('fine-coll-date').valueAsDate = new Date();
            const s = document.getElementById('fine-coll-name');
            s.innerHTML = '<option>সদস্য সিলেক্ট করুন</option>';
            (await getDocs(collection(db, "users"))).forEach(d => { if (d.data().status == 'approved' && d.data().role !== 'admin') { s.innerHTML += `<option value="${d.id}">${d.data().name}</option>`; } });
        };

        document.getElementById('btn-submit-fine-coll').onclick = async () => {
            const uid = document.getElementById('fine-coll-name').value;
            const amt = parseInt(document.getElementById('fine-coll-amount').value);
            const month = document.getElementById('fine-coll-month').value;
            const year = document.getElementById('fine-coll-year').value;
            const date = document.getElementById('fine-coll-date').value;
            const note = document.getElementById('fine-coll-note').value;
            const method = document.getElementById('fine-coll-method').value;
            if (uid === 'সদস্য সিলেক্ট করুন' || !amt) return alert("তথ্য দিন");
            if(confirm("জরিমানা জমা নিশ্চিত?")) {
                const nm = document.getElementById('fine-coll-name').options[document.getElementById('fine-coll-name').selectedIndex].text;
                await addDoc(collection(db, "deposits"), { uid, name: nm, amount: amt, month, year, method, note, depositDate: date, status: 'approved', type: 'fine', date: new Date(), submittedBy: 'admin' });
                activeEntryModal = 'fine-collection-modal';
                document.getElementById('fine-collection-modal').style.display = 'none';
                document.getElementById('receipt-modal').style.display = 'flex';
                document.getElementById('rec-name').innerText = nm; document.getElementById('rec-amount').innerText = amt; document.getElementById('rec-month').innerText = `Fine (${month} ${year})`; document.getElementById('rec-date').innerText = date; document.getElementById('rec-method').innerText = method; document.getElementById('rec-note').innerText = note;
                loadStats();
            }
        };

        document.getElementById('btn-due-list').onclick=async()=>{document.getElementById('due-list-modal').style.display='flex';const c=document.getElementById('due-users-container');c.innerHTML='...';try{const usersSnap=await getDocs(collection(db,"users"));const feesDoc=await getDoc(doc(db,"config","fees"));const fees=feesDoc.data()||{};const exFeesDoc=await getDoc(doc(db,"config","extraFees"));const extraFees=exFeesDoc.exists()?exFeesDoc.data():{};const depositsSnap=await getDocs(query(collection(db,"deposits"),where("status","==","approved")));const userPaidMonths={};depositsSnap.forEach(d=>{const uid=d.data().uid;if(!userPaidMonths[uid])userPaidMonths[uid]=new Set();userPaidMonths[uid].add(`${d.data().month}-${d.data().year}`)});c.innerHTML='';let currentDate=new Date();usersSnap.forEach(d=>{const u=d.data();if(u.status=='approved'&&u.role!=='admin'){let totalDue=0;const paidSet=userPaidMonths[d.id]||new Set();for(let y=2020;y<=currentDate.getFullYear();y++){if(fees[y]){for(let m=0;m<12;m++){if(y==currentDate.getFullYear()&&m>currentDate.getMonth())break;let mn=["January","February","March","April","May","June","July","August","September","October","November","December"][m];if(!paidSet.has(`${mn}-${y}`)){totalDue+=fees[y];}}}} Object.values(extraFees).forEach(f=>{if(parseInt(f.year)<=currentDate.getFullYear()){if(!paidSet.has(`${f.title}-${f.year}`)){totalDue+=parseInt(f.amount)}}}); c.innerHTML+=`<div class="smart-card" onclick="showDue('${d.id}','${u.name}')" style="cursor:pointer"><div><b>${u.name}</b><br>${u.phone}</div><div><span style="color:#dc2626; font-weight:bold; display:block; text-align:right">৳${totalDue}</span><small style="color:var(--primary)">বিস্তারিত <i class="fa-solid fa-arrow-right"></i></small></div></div>`;}}); }catch(e){console.error(e);}};
        
        document.getElementById('btn-deposit-list').onclick = async () => {
            document.getElementById('all-deposit-modal').style.display = 'flex';
            const container = document.getElementById('deposit-members-list');
            container.innerHTML = 'লোড হচ্ছে...';
            try {
                const usersSnap = await getDocs(collection(db, "users"));
                container.innerHTML = '';
                usersSnap.forEach(doc => { const u = doc.data(); if (u.role !== 'admin' && u.status === 'approved') { container.innerHTML += `<div class="smart-card"><div><b>${u.name}</b><br>${u.phone}</div><div style="text-align:right"><b>৳${u.totalDeposit||0}</b><br><small onclick="viewUserDeposits('${doc.id}', '${u.name}', ${u.totalDeposit||0})" style="color:var(--primary);cursor:pointer">বিস্তারিত <i class="fa-solid fa-arrow-right"></i></small></div></div>`; } });
            } catch (e) { console.error(e); }
        };

        window.viewUserDeposits = async (uid, name, total) => {
            document.getElementById('user-deposit-details-modal').style.display = 'flex';
            document.getElementById('dep-user-title').innerText = name;
            document.getElementById('dep-user-total').innerText = total;
            const listContainer = document.getElementById('dep-history-list');
            listContainer.innerHTML = 'লোড হচ্ছে...';
            try {
                const q = query(collection(db, "deposits"), where("uid", "==", uid), where("status", "==", "approved"));
                const querySnapshot = await getDocs(q);
                listContainer.innerHTML = '';
                querySnapshot.forEach(d => { const data = d.data(); listContainer.innerHTML += `<div class="smart-card" style="display:block"><b>${data.month} ${data.year}</b> - ৳${data.amount}<br><small>মাধ্যম: ${data.method} | তারিখ: ${data.depositDate}</small><button onclick="del('${d.id}', '${uid}', ${data.amount})" style="float:right;background:red;color:white;border:none;padding:2px 5px;border-radius:3px">Delete</button></div>`; });
            } catch (e) { console.error(e); }
        };

        document.getElementById('btn-money-entry').onclick=async()=>{
            document.getElementById('entry-modal').style.display='flex';
            document.getElementById('entry-date').valueAsDate=new Date();
            const s=document.getElementById('entry-name');
            s.innerHTML='<option>সদস্য সিলেক্ট করুন</option>';
            (await getDocs(collection(db,"users"))).forEach(d=>{if(d.data().status=='approved'&&d.data().role!=='admin')s.innerHTML+=`<option value="${d.id}">${d.data().name}</option>`});
            const feesDoc = await getDoc(doc(db, "config", "fees"));
            loadedFees = feesDoc.exists() ? feesDoc.data() : {};
            const y = document.getElementById('entry-year').value;
            document.getElementById('entry-amount').value = loadedFees[y] || 0;
        };

        document.getElementById('entry-year').onchange = () => { document.getElementById('entry-amount').value = loadedFees[document.getElementById('entry-year').value] || 0; };

        document.getElementById('btn-submit-entry').onclick=async()=>{
            const uid=document.getElementById('entry-name').value,amt=parseInt(document.getElementById('entry-amount').value),m=document.getElementById('entry-month').value,y=document.getElementById('entry-year').value,dt=document.getElementById('entry-date').value,nt=document.getElementById('entry-note').value; 
            if(uid === 'সদস্য সিলেক্ট করুন' || !amt) return alert("তথ্য দিন");
            if(confirm("জমা নিশ্চিত?")){ 
                const nm=document.getElementById('entry-name').options[document.getElementById('entry-name').selectedIndex].text; 
                await addDoc(collection(db,"deposits"),{uid,name:nm,amount:amt,month:m,year:y,method:document.getElementById('entry-method').value,note:nt,depositDate:dt,status:'approved',date:new Date(),submittedBy:'admin'}); 
                await updateDoc(doc(db,"users",uid),{totalDeposit:increment(amt)}); 
                await updateUserDue(uid); 
                activeEntryModal = 'entry-modal'; document.getElementById('entry-modal').style.display='none'; 
                document.getElementById('receipt-modal').style.display='flex'; 
                document.getElementById('rec-name').innerText=nm;document.getElementById('rec-date').innerText=dt;document.getElementById('rec-amount').innerText=amt;document.getElementById('rec-month').innerText=`${m} ${y}`;document.getElementById('rec-note').innerText=nt||"নাই";document.getElementById('rec-method').innerText=document.getElementById('entry-method').value;loadStats()
            }
        };

        window.closeReceiptModal = () => { document.getElementById('receipt-modal').style.display = 'none'; if(activeEntryModal) { document.getElementById(activeEntryModal).style.display = 'flex'; activeEntryModal = null; } };
        document.getElementById('btn-recalc-all').onclick=async()=>{if(!confirm("ডিউ রিক্যালকুলেট করবেন?"))return;const e=await getExp();const s=await getDocs(collection(db,"users"));s.forEach(d=>{if(d.data().role!=='admin')updateDoc(doc(db,"users",d.id),{totalDue:e-(d.data().totalDeposit||0)})});alert("Done");};
        document.getElementById('btn-app-config').onclick=async()=>{document.getElementById('config-modal').style.display='flex';const d=await getDoc(doc(db,"config","appSettings"));if(d.exists())document.getElementById('app-name-input').value=d.data().name||""};
        document.getElementById('btn-save-config').onclick=async()=>{const f=document.getElementById('app-logo-file').files[0],n=document.getElementById('app-name-input').value;let u=null;if(f){const fm=new FormData();fm.append("image",f);const r=await fetch(`https://api.imgbb.com/1/upload?key=${imgbbAPI}`,{method:"POST",body:fm});const d=await r.json();u=d.data.url}const dt={name:n};if(u)dt.logo=u;await setDoc(doc(db,"config","appSettings"),dt,{merge:true});alert("সেভ হয়েছে");location.reload()};
        document.getElementById('btn-save-member').onclick=async()=>{await updateDoc(doc(db,"users",document.getElementById('edit-mem-id').value),{name:document.getElementById('edit-mem-name').value,phone:document.getElementById('edit-mem-phone').value});alert("আপডেট হয়েছে");location.reload()};
        document.getElementById('btn-save-rules').onclick=async()=>{await setDoc(doc(db,"config","rules"),{text:document.getElementById('rules-text').value});alert("পোস্ট হয়েছে");document.getElementById('rules-modal').style.display='none'};
        document.getElementById('btn-rules').onclick=async()=>{document.getElementById('rules-modal').style.display='flex';const d=await getDoc(doc(db,"config","rules"));document.getElementById('rules-text').value=d.exists()?d.data().text:""};
        document.getElementById('btn-balance-fix').onclick=async()=>{if(!confirm("ডাটা ফিক্স করবেন?"))return;const e=await getExp();const us=await getDocs(collection(db,"users"));for(const u of us.docs){if(u.data().role==='admin')continue;let rd=0;(await getDocs(query(collection(db,"deposits"),where("uid","==",u.id),where("status","==","approved")))).forEach(d=>rd+=d.data().amount);await updateDoc(doc(db,"users",u.id),{totalDeposit:rd,totalDue:e-rd})}alert("ফিক্স হয়েছে");location.reload()};
        document.getElementById('btn-download-receipt').onclick=()=>{html2canvas(document.getElementById('receipt-box')).then(c=>{const l=document.createElement('a');l.download='Receipt.jpg';l.href=c.toDataURL();l.click()})};
    </script>
</body>
</html>
